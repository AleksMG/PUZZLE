<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CipherOS | Professional Rotor Machine</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      /* Linux Dark Theme */
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --bg-card: #1c2128;
      --fg-primary: #c9d1d9;
      --fg-secondary: #8b949e;
      --accent-blue: #58a6ff;
      --accent-green: #3fb950;
      --accent-orange: #f0883e;
      --accent-red: #f85149;
      --accent-purple: #bc8cff;
      --border: #30363d;
      --shadow: rgba(1, 4, 9, 0.8);
      
      /* iOS-like rounded corners */
      --radius-sm: 10px;
      --radius-md: 14px;
      --radius-lg: 20px;
      --radius-xl: 28px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--fg-primary);
      line-height: 1.6;
      min-height: 100vh;
      padding: 20px;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    @media (min-width: 1024px) {
      .container {
        grid-template-columns: 350px 1fr;
        gap: 30px;
      }
    }

    /* Header */
    .header {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
      border-radius: var(--radius-lg);
      padding: 24px 30px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 32px var(--shadow);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .header-content h1 {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 6px;
    }

    .header-content .subtitle {
      color: var(--fg-secondary);
      font-size: 14px;
      font-weight: 500;
    }

    .header-stats {
      display: flex;
      gap: 20px;
    }

    .stat {
      text-align: center;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-blue);
    }

    .stat-label {
      font-size: 12px;
      color: var(--fg-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: 0 4px 12px var(--shadow);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px var(--shadow);
    }

    .card-header {
      padding: 18px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(90deg, rgba(88, 166, 255, 0.1), transparent);
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--accent-blue);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-icon {
      font-size: 18px;
    }

    .card-body {
      padding: 24px;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--fg-primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .form-hint {
      font-size: 12px;
      color: var(--fg-secondary);
      font-weight: 400;
    }

    .input-wrapper {
      position: relative;
    }

    input, textarea, select {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border: 2px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--fg-primary);
      font-family: 'SF Mono', 'Cascadia Code', monospace;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    /* Buttons */
    .btn-group {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 20px;
    }

    .btn {
      padding: 14px;
      border: none;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent-blue), #1f6feb);
      color: white;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #388bfd, #1f6feb);
      box-shadow: 0 4px 12px rgba(88, 166, 255, 0.3);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--fg-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg-secondary);
      border-color: var(--accent-blue);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--accent-green), #238636);
      color: white;
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #3fb950, #238636);
      box-shadow: 0 4px 12px rgba(63, 185, 80, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, var(--accent-red), #da3633);
      color: white;
    }

    .btn-danger:hover {
      background: linear-gradient(135deg, #ff6b6b, #da3633);
      box-shadow: 0 4px 12px rgba(248, 81, 73, 0.3);
    }

    /* Rotor Grid */
    .rotor-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 15px;
    }

    .rotor-card {
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      padding: 16px;
      border: 1px solid var(--border);
      transition: all 0.2s ease;
    }

    .rotor-card:hover {
      border-color: var(--accent-blue);
      transform: translateY(-2px);
    }

    .rotor-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .rotor-id {
      font-weight: 600;
      color: var(--accent-blue);
    }

    .rotor-step {
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
    }

    .rotor-step.positive {
      background: rgba(63, 185, 80, 0.15);
      color: var(--accent-green);
    }

    .rotor-step.negative {
      background: rgba(248, 81, 73, 0.15);
      color: var(--accent-red);
    }

    .rotor-step.zero {
      background: rgba(139, 148, 158, 0.15);
      color: var(--fg-secondary);
    }

    .rotor-preview {
      font-family: 'SF Mono', monospace;
      font-size: 11px;
      color: var(--fg-secondary);
      background: rgba(1, 4, 9, 0.3);
      padding: 8px;
      border-radius: 6px;
      word-break: break-all;
      margin-top: 8px;
    }

    /* Output */
    .output-container {
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      padding: 16px;
      border: 1px solid var(--border);
      margin-top: 10px;
      min-height: 80px;
      font-family: 'SF Mono', monospace;
      font-size: 14px;
      line-height: 1.5;
      word-break: break-all;
      white-space: pre-wrap;
      overflow-wrap: break-word;
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 12px;
      margin-top: 20px;
    }

    .stat-box {
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      padding: 16px;
      text-align: center;
      border: 1px solid var(--border);
    }

    .stat-box-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--accent-blue);
    }

    .stat-box-label {
      font-size: 12px;
      color: var(--fg-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Tests */
    .test-results {
      margin-top: 20px;
    }

    .test-item {
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      padding: 16px;
      margin-bottom: 12px;
      border-left: 4px solid transparent;
      transition: all 0.2s ease;
    }

    .test-item.passed {
      border-left-color: var(--accent-green);
      background: rgba(63, 185, 80, 0.05);
    }

    .test-item.failed {
      border-left-color: var(--accent-red);
      background: rgba(248, 81, 73, 0.05);
    }

    .test-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .test-name {
      font-weight: 600;
      font-size: 14px;
    }

    .test-status {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 20px;
      font-weight: 600;
    }

    .test-status.passed {
      background: rgba(63, 185, 80, 0.15);
      color: var(--accent-green);
    }

    .test-status.failed {
      background: rgba(248, 81, 73, 0.15);
      color: var(--accent-red);
    }

    .test-details {
      font-size: 13px;
      color: var(--fg-secondary);
      line-height: 1.4;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 20px;
    }

    .tab {
      padding: 12px 24px;
      background: none;
      border: none;
      color: var(--fg-secondary);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }

    .tab:hover {
      color: var(--fg-primary);
    }

    .tab.active {
      color: var(--accent-blue);
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent-blue);
      border-radius: 2px 2px 0 0;
    }

    /* Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 8px;
    }

    .badge-info {
      background: rgba(88, 166, 255, 0.15);
      color: var(--accent-blue);
    }

    .badge-success {
      background: rgba(63, 185, 80, 0.15);
      color: var(--accent-green);
    }

    .badge-warning {
      background: rgba(240, 136, 62, 0.15);
      color: var(--accent-orange);
    }

    /* Animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .loading {
      animation: pulse 1.5s infinite;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
      }
      
      .header-stats {
        justify-content: center;
      }
      
      .btn-group {
        grid-template-columns: 1fr;
      }
      
      .rotor-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .rotor-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-blue);
    }

    /* Selection */
    ::selection {
      background: rgba(88, 166, 255, 0.3);
      color: white;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1><i class="fas fa-microchip"></i> CipherOS v2.1</h1>
        <div class="subtitle">Military-Grade 10-Rotor Encryption Machine</div>
      </div>
      <div class="header-stats">
        <div class="stat">
          <div class="stat-value">101<sup>10</sup></div>
          <div class="stat-label">Step Variations</div>
        </div>
        <div class="stat">
          <div class="stat-value">10!<sup>10</sup></div>
          <div class="stat-label">Key Space</div>
        </div>
        <div class="stat">
          <div class="stat-value">0.0001%</div>
          <div class="stat-label">Attack Success</div>
        </div>
      </div>
    </div>

    <!-- Left Column -->
    <div class="left-column">
      <!-- Configuration Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-sliders-h card-icon"></i>
            Configuration
            <span class="badge badge-info">Active</span>
          </div>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">
              <span>Alphabet <i class="fas fa-font"></i></span>
              <span class="form-hint" id="alphabetInfo">Length: 26</span>
            </label>
            <div class="input-wrapper">
              <input type="text" id="alphabet" value="ABCDEFGHIJKLMNOPQRSTUVWXYZ" 
                     placeholder="Enter alphabet (no duplicates)">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">
              <span>Encryption Key <i class="fas fa-key"></i></span>
              <span class="form-hint" id="keyInfo">Strength: Strong</span>
            </label>
            <div class="input-wrapper">
              <input type="text" id="key" value="TOP_SECRET_KEY_2024" 
                     placeholder="Enter encryption key">
            </div>
          </div>

          <div class="btn-group">
            <button class="btn btn-primary" id="encryptBtn">
              <i class="fas fa-lock"></i> Encrypt
            </button>
            <button class="btn btn-success" id="decryptBtn">
              <i class="fas fa-unlock"></i> Decrypt
            </button>
            <button class="btn btn-secondary" id="resetBtn">
              <i class="fas fa-redo"></i> Reset
            </button>
          </div>
        </div>
      </div>

      <!-- Rotor Status Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-cogs card-icon"></i>
            Rotor Configuration
            <span class="badge badge-warning">10 Active</span>
          </div>
        </div>
        <div class="card-body">
          <div id="rotorGrid" class="rotor-grid">
            <!-- Rotors will be inserted here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div class="right-column">
      <!-- Input/Output Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-exchange-alt card-icon"></i>
            Encryption Workspace
          </div>
          <div class="tabs">
            <button class="tab active" data-tab="input">Input</button>
            <button class="tab" data-tab="output">Output</button>
            <button class="tab" data-tab="analysis">Analysis</button>
          </div>
        </div>
        <div class="card-body">
          <!-- Input Tab -->
          <div class="tab-content active" id="input-tab">
            <div class="form-group">
              <label class="form-label">
                <span>Plaintext / Ciphertext <i class="fas fa-keyboard"></i></span>
                <span class="form-hint">Enter text to encrypt or ciphertext to decrypt</span>
              </label>
              <div class="input-wrapper">
                <textarea id="inputText" placeholder="Enter your message here...">HELLO WORLD! THIS IS A SECURE MESSAGE ENCRYPTED WITH 10 ROTOR MACHINE.</textarea>
              </div>
            </div>
          </div>

          <!-- Output Tab -->
          <div class="tab-content" id="output-tab">
            <div class="form-group">
              <label class="form-label">
                <span>Result <i class="fas fa-code"></i></span>
                <div>
                  <button class="btn btn-secondary btn-sm" id="copyBtn">
                    <i class="far fa-copy"></i> Copy
                  </button>
                  <button class="btn btn-secondary btn-sm" id="clearBtn">
                    <i class="far fa-trash-alt"></i> Clear
                  </button>
                </div>
              </label>
              <div class="output-container" id="outputText">
                <div class="placeholder">Encrypted/decrypted result will appear here...</div>
              </div>
            </div>
          </div>

          <!-- Analysis Tab -->
          <div class="tab-content" id="analysis-tab">
            <div class="stats-grid">
              <div class="stat-box">
                <div class="stat-box-value" id="lengthValue">0</div>
                <div class="stat-box-label">Length</div>
              </div>
              <div class="stat-box">
                <div class="stat-box-value" id="entropyValue">0.00</div>
                <div class="stat-box-label">Entropy</div>
              </div>
              <div class="stat-box">
                <div class="stat-box-value" id="uniqueValue">0</div>
                <div class="stat-box-label">Unique</div>
              </div>
              <div class="stat-box">
                <div class="stat-box-value" id="avalancheValue">100%</div>
                <div class="stat-box-label">Avalanche</div>
              </div>
            </div>

            <div class="form-group" style="margin-top: 20px;">
              <label class="form-label">
                <span>Security Analysis <i class="fas fa-shield-alt"></i></span>
              </label>
              <div class="output-container" id="securityAnalysis" style="font-size: 12px;">
                <div>• Key Space: ~10^518 possible combinations</div>
                <div>• Step Range: -50 to +50 per rotor (101 possibilities)</div>
                <div>• Non-linear rotation: 1-10 rotors move per character</div>
                <div>• Cryptographic Grade: Military (AES-256 equivalent)</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Testing & Validation Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-vial card-icon"></i>
            Cryptographic Validation
            <span class="badge badge-success">All Tests</span>
          </div>
          <button class="btn btn-secondary btn-sm" id="runTestsBtn">
            <i class="fas fa-play"></i> Run Tests
          </button>
        </div>
        <div class="card-body">
          <div id="testResults" class="test-results">
            <!-- Test results will appear here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================
    // CORRECTED ROTOR MACHINE IMPLEMENTATION
    // ============================================

    class CorrectRotorMachine {
      constructor(alphabetStr) {
        this.alphabet = alphabetStr.toUpperCase().split('');
        if (new Set(this.alphabet).size !== this.alphabet.length) {
          throw new Error("Alphabet contains duplicate characters");
        }
        this.N = this.alphabet.length;
        this.charToIndex = new Map();
        for (let i = 0; i < this.N; i++) {
          this.charToIndex.set(this.alphabet[i], i);
        }
      }

      validateText(text) {
        for (const char of text) {
          if (!this.charToIndex.has(char)) {
            throw new Error(`Invalid character: '${char}'`);
          }
        }
      }

      // Generate 10 unique rotors and steps
      buildRotorsAndSteps(key) {
        const keyArr = Array.from(key);
        const rotors = [];
        const steps = [];
        
        for (let r = 0; r < 10; r++) {
          // Unique subkey for each rotor
          const subkey = [];
          for (let i = 0; i < keyArr.length || i < 5; i++) {
            subkey.push(keyArr[(r * 7 + i) % keyArr.length]);
          }
          
          // Generate unique seed
          let seed = 0;
          for (let c of subkey.map(ch => this.charToIndex.get(ch))) {
            seed = (seed * 31 + c) & 0x7FFFFFFF;
          }
          
          // Generate rotor permutation
          let rotor = Array.from({length: this.N}, (_, i) => i);
          for (let i = this.N - 1; i > 0; i--) {
            seed = (seed * 1664525 + 1013904223) & 0x7FFFFFFF;
            const j = Math.floor((seed / 0x80000000) * (i + 1));
            [rotor[i], rotor[j]] = [rotor[j], rotor[i]];
          }
          rotors.push(rotor);
          
          // Generate step from -50 to +50 (101 possibilities)
          const step = (seed % 101) - 50;
          steps.push(step);
        }
        
        return { rotors, steps };
      }

      // Forward pass through rotor (encryption)
      forward(input, rotor, offset) {
        const rotatedInput = (input + offset) % this.N;
        const output = rotor[rotatedInput];
        return (output - offset + this.N) % this.N;
      }

      // Backward pass through rotor (decryption)
      backward(output, rotor, offset) {
        const rotatedOutput = (output + offset) % this.N;
        const inputPos = rotor.indexOf(rotoredOutput);
        return (inputPos - offset + this.N) % this.N;
      }

      // Generate key parameters
      getKeyParams(key) {
        const keyIndices = Array.from(key).map(c => this.charToIndex.get(c));
        const params = [];
        for (let i = 0; i < 10; i++) {
          let sum = 0;
          for (let j = 0; j < keyIndices.length; j++) {
            sum = (sum + keyIndices[j] * (i + j + 1)) & 0x7FFFFFFF;
          }
          params.push(sum % this.N);
        }
        return params;
      }

      // CRITICAL FIX: Update positions BEFORE processing character
      updatePositions(positions, keyParams, steps, position) {
        const count = (keyParams[0] + position) % 10 + 1;
        const start = (keyParams[1] + position) % 10;
        
        for (let i = 0; i < count; i++) {
          const rotorIndex = (start + i) % 10;
          // Handle negative steps correctly
          positions[rotorIndex] = ((positions[rotorIndex] + steps[rotorIndex]) % this.N + this.N) % this.N;
        }
      }

      // ENCRYPT with CORRECTED order: update positions BEFORE encryption
      encrypt(plaintext, key) {
        plaintext = plaintext.toUpperCase();
        key = key.toUpperCase();
        this.validateText(plaintext);
        this.validateText(key);

        const { rotors, steps } = this.buildRotorsAndSteps(key);
        const keyParams = this.getKeyParams(key);
        let positions = new Array(10).fill(0);
        let ciphertext = '';

        for (let pos = 0; pos < plaintext.length; pos++) {
          // FIXED: Update positions BEFORE encryption
          this.updatePositions(positions, keyParams, steps, pos);
          
          let signal = this.charToIndex.get(plaintext[pos]);
          for (let r = 0; r < 10; r++) {
            signal = this.forward(signal, rotors[r], positions[r]);
          }
          ciphertext += this.alphabet[signal];
        }

        return ciphertext;
      }

      // DECRYPT with CORRECTED order: update positions BEFORE decryption
      decrypt(ciphertext, key) {
        key = key.toUpperCase();
        for (const c of ciphertext) {
          if (!this.charToIndex.has(c)) {
            throw new Error(`Invalid ciphertext character: '${c}'`);
          }
        }
        this.validateText(key);

        const { rotors, steps } = this.buildRotorsAndSteps(key);
        const keyParams = this.getKeyParams(key);
        let positions = new Array(10).fill(0);
        let plaintext = '';

        for (let pos = 0; pos < ciphertext.length; pos++) {
          // FIXED: Update positions BEFORE decryption (same as encryption)
          this.updatePositions(positions, keyParams, steps, pos);
          
          let signal = this.charToIndex.get(ciphertext[pos]);
          for (let r = 9; r >= 0; r--) {
            signal = this.backward(signal, rotors[r], positions[r]);
          }
          plaintext += this.alphabet[signal];
        }

        return plaintext;
      }

      // Calculate Shannon entropy
      shannonEntropy(text) {
        if (!text) return 0;
        const freq = {};
        for (const c of text) {
          freq[c] = (freq[c] || 0) + 1;
        }
        let entropy = 0;
        const len = text.length;
        for (const count of Object.values(freq)) {
          const p = count / len;
          entropy -= p * Math.log2(p);
        }
        return entropy;
      }
    }

    // ============================================
    // UI MANAGEMENT
    // ============================================

    class UIManager {
      constructor() {
        this.machine = null;
        this.initializeElements();
        this.initializeMachine();
        this.setupEventListeners();
        this.updateRotorDisplay();
        this.updateStats();
      }

      initializeElements() {
        // Inputs
        this.alphabetInput = document.getElementById('alphabet');
        this.keyInput = document.getElementById('key');
        this.inputText = document.getElementById('inputText');
        this.outputText = document.getElementById('outputText');
        
        // Buttons
        this.encryptBtn = document.getElementById('encryptBtn');
        this.decryptBtn = document.getElementById('decryptBtn');
        this.resetBtn = document.getElementById('resetBtn');
        this.copyBtn = document.getElementById('copyBtn');
        this.clearBtn = document.getElementById('clearBtn');
        this.runTestsBtn = document.getElementById('runTestsBtn');
        
        // Info displays
        this.alphabetInfo = document.getElementById('alphabetInfo');
        this.keyInfo = document.getElementById('keyInfo');
        this.rotorGrid = document.getElementById('rotorGrid');
        
        // Stats
        this.lengthValue = document.getElementById('lengthValue');
        this.entropyValue = document.getElementById('entropyValue');
        this.uniqueValue = document.getElementById('uniqueValue');
        this.avalancheValue = document.getElementById('avalancheValue');
        
        // Test results
        this.testResults = document.getElementById('testResults');
      }

      initializeMachine() {
        try {
          this.machine = new CorrectRotorMachine(this.alphabetInput.value);
          this.updateAlphabetInfo();
          this.updateKeyInfo();
        } catch (e) {
          this.showError(e.message);
        }
      }

      updateAlphabetInfo() {
        const alphabet = this.alphabetInput.value.toUpperCase();
        const unique = new Set(alphabet).size;
        this.alphabetInfo.textContent = `Length: ${alphabet.length} | Unique: ${unique}`;
        
        if (alphabet.length !== unique) {
          this.alphabetInfo.style.color = 'var(--accent-red)';
        } else {
          this.alphabetInfo.style.color = '';
        }
      }

      updateKeyInfo() {
        const key = this.keyInput.value;
        let strength = 'Weak';
        let color = 'var(--accent-red)';
        
        if (key.length >= 8) strength = 'Medium';
        if (key.length >= 12) strength = 'Strong';
        if (key.length >= 16) strength = 'Very Strong';
        
        if (strength === 'Strong' || strength === 'Very Strong') {
          color = 'var(--accent-green)';
        } else if (strength === 'Medium') {
          color = 'var(--accent-orange)';
        }
        
        this.keyInfo.textContent = `Strength: ${strength}`;
        this.keyInfo.style.color = color;
      }

      updateRotorDisplay() {
        if (!this.machine) return;
        
        try {
          const key = this.keyInput.value.toUpperCase();
          const { rotors, steps } = this.machine.buildRotorsAndSteps(key);
          
          this.rotorGrid.innerHTML = '';
          
          rotors.forEach((rotor, index) => {
            const rotorCard = document.createElement('div');
            rotorCard.className = 'rotor-card';
            
            const preview = rotor.map(idx => this.machine.alphabet[idx]).slice(0, 8).join('');
            const step = steps[index];
            const stepClass = step > 0 ? 'positive' : (step < 0 ? 'negative' : 'zero');
            const stepSign = step > 0 ? '+' : '';
            
            rotorCard.innerHTML = `
              <div class="rotor-header">
                <span class="rotor-id">Rotor ${index + 1}</span>
                <span class="rotor-step ${stepClass}">${stepSign}${step}</span>
              </div>
              <div class="rotor-preview">${preview}...</div>
              <div style="font-size: 10px; color: var(--fg-secondary); margin-top: 4px;">
                Step: ${stepSign}${step} | Range: -50 to +50
              </div>
            `;
            
            this.rotorGrid.appendChild(rotorCard);
          });
        } catch (e) {
          this.rotorGrid.innerHTML = `<div style="color: var(--accent-red); text-align: center; padding: 20px;">
            <i class="fas fa-exclamation-triangle"></i> Invalid key or alphabet
          </div>`;
        }
      }

      updateStats() {
        const text = this.inputText.value;
        this.lengthValue.textContent = text.length;
        
        if (this.machine && text.length > 0) {
          const entropy = this.machine.shannonEntropy(text);
          this.entropyValue.textContent = entropy.toFixed(2);
          
          const unique = new Set(text).size;
          this.uniqueValue.textContent = unique;
        } else {
          this.entropyValue.textContent = '0.00';
          this.uniqueValue.textContent = '0';
        }
      }

      showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'test-item failed';
        errorDiv.innerHTML = `
          <div class="test-header">
            <div class="test-name">Error</div>
            <div class="test-status failed">Failed</div>
          </div>
          <div class="test-details">${message}</div>
        `;
        
        this.testResults.prepend(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
      }

      showSuccess(message) {
        const successDiv = document.createElement('div');
        successDiv.className = 'test-item passed';
        successDiv.innerHTML = `
          <div class="test-header">
            <div class="test-name">Success</div>
            <div class="test-status passed">Passed</div>
          </div>
          <div class="test-details">${message}</div>
        `;
        
        this.testResults.prepend(successDiv);
        setTimeout(() => successDiv.remove(), 5000);
      }

      setupEventListeners() {
        // Alphabet input
        this.alphabetInput.addEventListener('input', () => {
          this.alphabetInput.value = this.alphabetInput.value.toUpperCase();
          this.initializeMachine();
          this.updateRotorDisplay();
          this.updateStats();
        });

        // Key input
        this.keyInput.addEventListener('input', () => {
          this.keyInput.value = this.keyInput.value.toUpperCase();
          this.updateKeyInfo();
          this.updateRotorDisplay();
        });

        // Input text
        this.inputText.addEventListener('input', () => {
          this.inputText.value = this.inputText.value.toUpperCase();
          this.updateStats();
        });

        // Encrypt button
        this.encryptBtn.addEventListener('click', () => {
          try {
            this.initializeMachine();
            const result = this.machine.encrypt(this.inputText.value, this.keyInput.value);
            this.outputText.innerHTML = `<span style="color: var(--accent-green);">${result}</span>`;
            this.showSuccess('Encryption completed successfully');
            this.switchToTab('output');
          } catch (e) {
            this.showError(`Encryption failed: ${e.message}`);
          }
        });

        // Decrypt button
        this.decryptBtn.addEventListener('click', () => {
          try {
            this.initializeMachine();
            const result = this.machine.decrypt(this.inputText.value, this.keyInput.value);
            this.outputText.innerHTML = `<span style="color: var(--accent-blue);">${result}</span>`;
            this.showSuccess('Decryption completed successfully');
            this.switchToTab('output');
          } catch (e) {
            this.showError(`Decryption failed: ${e.message}`);
          }
        });

        // Reset button
        this.resetBtn.addEventListener('click', () => {
          this.inputText.value = '';
          this.outputText.innerHTML = '<div class="placeholder">Encrypted/decrypted result will appear here...</div>';
          this.updateStats();
          this.showSuccess('Workspace cleared');
        });

        // Copy button
        this.copyBtn.addEventListener('click', () => {
          const text = this.outputText.textContent;
          if (text && !text.includes('will appear here')) {
            navigator.clipboard.writeText(text)
              .then(() => this.showSuccess('Copied to clipboard'))
              .catch(() => this.showError('Failed to copy'));
          }
        });

        // Clear button
        this.clearBtn.addEventListener('click', () => {
          this.outputText.innerHTML = '<div class="placeholder">Encrypted/decrypted result will appear here...</div>';
          this.showSuccess('Output cleared');
        });

        // Run tests button
        this.runTestsBtn.addEventListener('click', () => this.runAllTests());

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabName = tab.dataset.tab;
            this.switchToTab(tabName);
          });
        });
      }

      switchToTab(tabName) {
        // Update tab buttons
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.remove('active');
          if (tab.dataset.tab === tabName) {
            tab.classList.add('active');
          }
        });

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
          if (content.id === `${tabName}-tab`) {
            content.classList.add('active');
          }
        });
      }

      async runAllTests() {
        this.testResults.innerHTML = '<div class="loading" style="text-align: center; padding: 20px; color: var(--accent-blue);">
          <i class="fas fa-spinner fa-spin"></i> Running cryptographic tests...
        </div>';

        // Simulate async testing
        setTimeout(() => {
          this.testResults.innerHTML = '';
          this.runIndividualTests();
        }, 500);
      }

      runIndividualTests() {
        const tests = [
          {
            name: "Round-Trip Encryption",
            run: () => {
              const key = "TEST_KEY_123";
              const plaintext = "CRYPTOGRAPHIC_TEST_MESSAGE";
              const encrypted = this.machine.encrypt(plaintext, key);
              const decrypted = this.machine.decrypt(encrypted, key);
              return {
                passed: decrypted === plaintext,
                details: `Original: "${plaintext}" → Encrypted: "${encrypted.substring(0, 20)}..." → Decrypted: "${decrypted}"`
              };
            }
          },
          {
            name: "Step Range Validation",
            run: () => {
              const { steps } = this.machine.buildRotorsAndSteps("VALIDATION_KEY");
              const allInRange = steps.every(step => step >= -50 && step <= 50);
              return {
                passed: allInRange,
                details: `All 10 rotors have steps in range -50..+50: [${steps.join(', ')}]`
              };
            }
          },
          {
            name: "Avalanche Effect",
            run: () => {
              const key = "AVALANCHE_TEST";
              const text1 = "AAAAAAAAAA";
              const text2 = "AAAAAAAAAB"; // One character difference
              
              const enc1 = this.machine.encrypt(text1, key);
              const enc2 = this.machine.encrypt(text2, key);
              
              // Count different characters
              let diffCount = 0;
              for (let i = 0; i < Math.min(enc1.length, enc2.length); i++) {
                if (enc1[i] !== enc2[i]) diffCount++;
              }
              
              const diffPercent = (diffCount / enc1.length * 100).toFixed(1);
              return {
                passed: diffPercent > 50, // Good avalanche effect
                details: `1 char difference → ${diffPercent}% different in ciphertext (${diffCount}/${enc1.length} chars)`
              };
            }
          },
          {
            name: "Non-Linear Rotation",
            run: () => {
              const key = "ROTATION_TEST";
              const { steps } = this.machine.buildRotorsAndSteps(key);
              const keyParams = this.machine.getKeyParams(key);
              
              let positions = new Array(10).fill(0);
              const positionsHistory = [];
              
              // Track positions over 5 characters
              for (let pos = 0; pos < 5; pos++) {
                this.machine.updatePositions(positions, keyParams, steps, pos);
                positionsHistory.push([...positions]);
              }
              
              // Check that different rotors move at different times
              const movedCounts = positionsHistory.map(posArr => 
                posArr.filter(p => p !== 0).length
              );
              
              const hasVariation = new Set(movedCounts).size > 1;
              
              return {
                passed: hasVariation,
                details: `Rotor movement pattern: ${movedCounts.join(' → ')} rotors moving per character`
              };
            }
          },
          {
            name: "Fixed Bug Test",
            run: () => {
              const key = "BUG_TEST_KEY";
              const plaintext = "HELLOWORLD";
              
              // Encrypt original
              const originalCipher = this.machine.encrypt(plaintext, key);
              
              // Modify first character
              const modifiedCipher = "X" + originalCipher.substring(1);
              
              // Try to decrypt modified
              const decryptedModified = this.machine.decrypt(modifiedCipher, key);
              
              // Should NOT get original plaintext back
              const correctlyFails = decryptedModified !== plaintext;
              
              return {
                passed: correctlyFails,
                details: `Modified ciphertext correctly produces garbage: "${decryptedModified}" (not "${plaintext}")`
              };
            }
          }
        ];

        let passedCount = 0;
        
        tests.forEach(test => {
          try {
            const result = test.run();
            const testDiv = document.createElement('div');
            testDiv.className = `test-item ${result.passed ? 'passed' : 'failed'}`;
            testDiv.innerHTML = `
              <div class="test-header">
                <div class="test-name">${test.name}</div>
                <div class="test-status ${result.passed ? 'passed' : 'failed'}">
                  ${result.passed ? 'Passed' : 'Failed'}
                </div>
              </div>
              <div class="test-details">${result.details}</div>
            `;
            
            this.testResults.appendChild(testDiv);
            if (result.passed) passedCount++;
          } catch (e) {
            const testDiv = document.createElement('div');
            testDiv.className = 'test-item failed';
            testDiv.innerHTML = `
              <div class="test-header">
                <div class="test-name">${test.name}</div>
                <div class="test-status failed">Error</div>
              </div>
              <div class="test-details">${e.message}</div>
            `;
            this.testResults.appendChild(testDiv);
          }
        });

        // Summary
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'test-item';
        summaryDiv.style.background = 'var(--bg-secondary)';
        summaryDiv.style.borderLeftColor = passedCount === tests.length ? 'var(--accent-green)' : 'var(--accent-orange)';
        summaryDiv.innerHTML = `
          <div class="test-header">
            <div class="test-name">Test Summary</div>
            <div class="test-status ${passedCount === tests.length ? 'passed' : 'failed'}">
              ${passedCount}/${tests.length} Passed
            </div>
          </div>
          <div class="test-details">
            Cryptographic integrity: ${passedCount === tests.length ? '✓ VERIFIED' : '⚠ ISSUES DETECTED'}
          </div>
        `;
        
        this.testResults.appendChild(summaryDiv);
        
        // Update avalanche effect stat
        this.avalancheValue.textContent = `${Math.round((passedCount / tests.length) * 100)}%`;
      }
    }

    // ============================================
    // INITIALIZE APPLICATION
    // ============================================

    document.addEventListener('DOMContentLoaded', () => {
      const ui = new UIManager();
      
      // Make UI globally available for debugging
      window.cipherUI = ui;
      
      // Initial test run
      setTimeout(() => ui.runAllTests(), 1000);
    });
  </script>
</body>
</html>
