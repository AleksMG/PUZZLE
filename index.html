<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Base36 Box Cipher</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #0d1117;
            color: #c9d1d9;
            line-height: 1.6;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .container {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            color: #58a6ff;
            margin-bottom: 20px;
            font-size: 2em;
        }
        
        h2 {
            color: #58a6ff;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #8b949e;
            font-weight: bold;
        }
        
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            color: #c9d1d9;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #2ea043;
        }
        
        .btn-secondary {
            background: #30363d;
        }
        
        .btn-secondary:hover {
            background: #484f58;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .status {
            padding: 10px;
            background: #1c2128;
            border: 1px solid #30363d;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .matrix {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            margin: 10px 0;
            max-width: 300px;
        }
        
        .matrix-cell {
            padding: 5px;
            background: #1c2128;
            border: 1px solid #30363d;
            text-align: center;
            font-size: 12px;
        }
        
        .debug {
            font-size: 12px;
            color: #8b949e;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <h1>Base36 Box Cipher</h1>
    
    <div class="container">
        <div class="input-group">
            <label for="key">Ключ:</label>
            <input type="text" id="key" placeholder="Введите ключ (любые символы)" value="secretkey">
        </div>
        
        <div class="input-group">
            <label for="inputText">Исходный текст:</label>
            <textarea id="inputText" placeholder="Введите текст для шифрования (только 0-9a-z)">hello123</textarea>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="encrypt()">Зашифровать</button>
            <button class="btn" onclick="decrypt()">Расшифровать</button>
            <button class="btn btn-secondary" onclick="clearAll()">Очистить</button>
        </div>
        
        <div class="input-group">
            <label for="outputText">Результат:</label>
            <textarea id="outputText" readonly placeholder="Результат появится здесь..."></textarea>
        </div>
        
        <div class="status" id="status">Готов к работе</div>
    </div>

    <script>
        // ==================== GF(2⁶) АРИФМЕТИКА ====================
        class GF64 {
            static add(a, b) {
                return a ^ b;
            }
            
            static mul(a, b) {
                let p = 0;
                for (let i = 0; i < 6; i++) {
                    if (b & 1) p ^= a;
                    b >>= 1;
                    const carry = a & 0x20;
                    a = (a << 1) & 0x3F;
                    if (carry) a ^= 0x2D;
                }
                return p;
            }
        }

        // ==================== MDS МАТРИЦЫ ====================
        const MDS_MATRIX = [
            [0x01, 0x02, 0x04, 0x08, 0x10, 0x20],
            [0x20, 0x01, 0x02, 0x04, 0x08, 0x10],
            [0x10, 0x20, 0x01, 0x02, 0x04, 0x08],
            [0x08, 0x10, 0x20, 0x01, 0x02, 0x04],
            [0x04, 0x08, 0x10, 0x20, 0x01, 0x02],
            [0x02, 0x04, 0x08, 0x10, 0x20, 0x01]
        ];

        // ==================== BASE36 КОНСТАНТЫ ====================
        const BASE36_CHARS = '0123456789abcdefghijklmnopqrstuvwxyz';

        // ==================== S-BOX ГЕНЕРАЦИЯ ====================
        function generateSBox(key) {
            let s = Array.from({length: 64}, (_, i) => i);
            let j = 0;
            
            const keyBytes = Array.from(key).map(c => c.charCodeAt(0) & 0x3F);
            if (keyBytes.length === 0) keyBytes.push(0);
            
            for (let i = 0; i < 64; i++) {
                j = (j + s[i] + keyBytes[i % keyBytes.length]) % 64;
                [s[i], s[j]] = [s[j], s[i]];
            }
            
            return s.slice(0, 36);
        }

        // ==================== ОСНОВНЫЕ ОПЕРАЦИИ ====================
        function subBytes(state, sbox) {
            const newState = JSON.parse(JSON.stringify(state));
            for (let i = 0; i < 6; i++) {
                for (let j = 0; j < 6; j++) {
                    newState[i][j] = sbox[newState[i][j]];
                }
            }
            return newState;
        }

        function shiftRows(state) {
            const newState = JSON.parse(JSON.stringify(state));
            for (let i = 0; i < 6; i++) {
                newState[i] = [...newState[i].slice(i), ...newState[i].slice(0, i)];
            }
            return newState;
        }

        function invShiftRows(state) {
            const newState = JSON.parse(JSON.stringify(state));
            for (let i = 0; i < 6; i++) {
                newState[i] = [...newState[i].slice(6-i), ...newState[i].slice(0, 6-i)];
            }
            return newState;
        }

        function mixColumns(state) {
            const newState = Array(6).fill().map(() => Array(6).fill(0));
            
            for (let col = 0; col < 6; col++) {
                for (let i = 0; i < 6; i++) {
                    for (let j = 0; j < 6; j++) {
                        newState[i][col] = GF64.add(
                            newState[i][col],
                            GF64.mul(MDS_MATRIX[i][j], state[j][col])
                        );
                    }
                }
            }
            
            return newState;
        }

        // ==================== ПРЕОБРАЗОВАНИЯ БЛОКОВ ====================
        function textToBlock(text) {
            const paddedText = text.padEnd(36, '0');
            const nums = Array.from(paddedText)
                .map(c => {
                    const index = BASE36_CHARS.indexOf(c);
                    return index === -1 ? 0 : index;
                });
            
            const block = [];
            for (let i = 0; i < 6; i++) {
                block.push(nums.slice(i * 6, i * 6 + 6));
            }
            return block;
        }

        function blockToText(block) {
            return block.flat()
                .map(n => BASE36_CHARS[n % 36])
                .join('');
        }

        // ==================== ШИФРОВАНИЕ/ДЕШИФРОВАНИЕ ====================
        function encryptBlock(block, sbox, rounds = 4) {
            let state = JSON.parse(JSON.stringify(block));
            
            for (let round = 0; round < rounds; round++) {
                state = subBytes(state, sbox);
                state = shiftRows(state);
                state = mixColumns(state);
            }
            
            return state;
        }

        function decryptBlock(block, sbox, rounds = 4) {
            let state = JSON.parse(JSON.stringify(block));
            const inverseSbox = generateInverseSbox(sbox);
            
            for (let round = 0; round < rounds; round++) {
                state = mixColumns(state);
                state = invShiftRows(state);
                state = subBytes(state, inverseSbox);
            }
            
            return state;
        }

        function generateInverseSbox(sbox) {
            const inverse = new Array(36);
            for (let i = 0; i < 36; i++) {
                inverse[sbox[i]] = i;
            }
            return inverse;
        }

        // ==================== ОБРАБОТКА ТЕКСТА ====================
        function processText(text, key, encrypt = true) {
            const sbox = generateSBox(key);
            const chunks = [];
            
            for (let i = 0; i < text.length; i += 36) {
                chunks.push(text.substr(i, 36));
            }
            
            const resultChunks = [];
            
            for (const chunk of chunks) {
                const block = textToBlock(chunk);
                const processedBlock = encrypt ? 
                    encryptBlock(block, sbox) : 
                    decryptBlock(block, sbox);
                resultChunks.push(blockToText(processedBlock));
            }
            
            return resultChunks.join('');
        }

        // ==================== ИНТЕРФЕЙС ====================
        function encrypt() {
            const key = document.getElementById('key').value;
            const inputText = document.getElementById('inputText').value.toLowerCase().replace(/[^0-9a-z]/g, '');
            
            if (!key) {
                showStatus('Ошибка: Введите ключ', 'error');
                return;
            }
            
            if (!inputText) {
                showStatus('Ошибка: Введите текст для шифрования', 'error');
                return;
            }
            
            try {
                showStatus('Шифрование...', 'working');
                const result = processText(inputText, key, true);
                document.getElementById('outputText').value = result;
                showStatus('Текст зашифрован успешно', 'success');
            } catch (error) {
                showStatus('Ошибка при шифровании: ' + error.message, 'error');
            }
        }

        function decrypt() {
            const key = document.getElementById('key').value;
            const inputText = document.getElementById('inputText').value.toLowerCase().replace(/[^0-9a-z]/g, '');
            
            if (!key) {
                showStatus('Ошибка: Введите ключ', 'error');
                return;
            }
            
            if (!inputText) {
                showStatus('Ошибка: Введите текст для дешифрования', 'error');
                return;
            }
            
            try {
                showStatus('Дешифрование...', 'working');
                const result = processText(inputText, key, false);
                document.getElementById('outputText').value = result;
                showStatus('Текст расшифрован успешно', 'success');
            } catch (error) {
                showStatus('Ошибка при дешифровании: ' + error.message, 'error');
            }
        }

        function clearAll() {
            document.getElementById('inputText').value = '';
            document.getElementById('outputText').value = '';
            document.getElementById('status').textContent = 'Готов к работе';
            document.getElementById('status').style.color = '#c9d1d9';
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            
            switch (type) {
                case 'error':
                    status.style.color = '#f85149';
                    break;
                case 'success':
                    status.style.color = '#3fb950';
                    break;
                case 'working':
                    status.style.color = '#d29922';
                    break;
                default:
                    status.style.color = '#c9d1d9';
            }
        }
    </script>
</body>
</html>
